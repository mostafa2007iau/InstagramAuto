<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:InstagramAuto.Client.ViewModels"
             x:Class="InstagramAuto.Client.Views.PostsPage"
             Title="مدیریت پست‌ها و قوانین"
             BackgroundColor="#F4EEFF">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="ایجاد قانون جدید" 
                     Command="{Binding CreateRuleCommand}"
                     IsEnabled="{Binding HasSelectedPosts}" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,*" Padding="16">
        <!-- Selection Info Bar -->
        <Frame Grid.Row="0" 
               IsVisible="{Binding HasSelectedPosts}"
               BackgroundColor="#7B5BF2"
               Margin="0,0,0,16">
            <Grid ColumnDefinitions="*,Auto">
                <Label Text="{Binding SelectionInfoText}" 
                       TextColor="White"
                       VerticalOptions="Center" />
                <Button Grid.Column="1"
                        Text="لغو انتخاب"
                        Command="{Binding ClearSelectionCommand}"
                        BackgroundColor="Transparent"
                        TextColor="White" />
            </Grid>
        </Frame>

        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="16">
                <!-- Error Display -->
                <Frame IsVisible="{Binding HasError}"
                       BackgroundColor="#FFECEC"
                       BorderColor="#FFB3B3"
                       Padding="16">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="{Binding ErrorMessage}"
                               TextColor="#B00020"
                               FontAttributes="Bold" />
                        <Editor Text="{Binding ErrorDetails}"
                                IsReadOnly="True"
                                AutoSize="TextChanges" />
                        <Button Text="کپی خطا"
                                Command="{Binding CopyErrorCommand}"
                                BackgroundColor="#F3F3F3"
                                TextColor="#111" />
                    </VerticalStackLayout>
                </Frame>

                <!-- Posts Grid -->
                <CollectionView ItemsSource="{Binding Items}"
                              SelectionMode="Multiple"
                              SelectedItems="{Binding SelectedPosts}"
                              RemainingItemsThreshold="6"
                              RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" 
                                       Span="2"
                                       HorizontalItemSpacing="8"
                                       VerticalItemSpacing="8" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.EmptyView>
                        <VerticalStackLayout Padding="20" Spacing="8">
                            <Label Text="هیچ پستی یافت نشد"
                                   HorizontalTextAlignment="Center"
                                   TextColor="#666" />
                            <Button Text="بارگیری مجدد"
                                    Command="{Binding RefreshCommand}"
                                    HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Padding="12"
                                   BorderColor="{Binding IsSelected, Converter={StaticResource SelectedItemBorderColorConverter}}"
                                   BackgroundColor="White">
                                <Grid RowDefinitions="Auto,Auto,Auto">
                                    <!-- Image -->
                                    <Grid>
                                        <Image Source="{Binding ThumbnailUrl}"
                                               Aspect="AspectFill"
                                               HeightRequest="160" />
                                        
                                        <!-- Rules Badge -->
                                        <Frame IsVisible="{Binding HasRules}"
                                               BackgroundColor="#7B5BF2"
                                               Padding="8,4"
                                               CornerRadius="12"
                                               HorizontalOptions="End"
                                               VerticalOptions="Start"
                                               Margin="8">
                                            <Label Text="{Binding RulesCount, StringFormat='{0} قانون'}"
                                                   TextColor="White"
                                                   FontSize="12" />
                                        </Frame>
                                    </Grid>

                                    <!-- Caption -->
                                    <Label Grid.Row="1"
                                           Text="{Binding Caption}"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="2"
                                           Margin="0,8" />

                                    <!-- Actions -->
                                    <Grid Grid.Row="2" 
                                          ColumnDefinitions="Auto,*,Auto"
                                          Margin="0,8,0,0">
                                        <Button Grid.Column="0"
                                                Text="مشاهده"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:PostsViewModel}}, Path=ViewPostCommand}"
                                                CommandParameter="{Binding .}" />
                                        
                                        <Button Grid.Column="2"
                                                Text="قوانین"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:PostsViewModel}}, Path=ManageRulesCommand}"
                                                CommandParameter="{Binding .}" />
                                    </Grid>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="1"
                          IsRunning="{Binding IsBusy}"
                          IsVisible="{Binding IsBusy}"
                          HorizontalOptions="Center"
                          VerticalOptions="Center" />
    </Grid>
</ContentPage>
